name: Deploy Backend (self-hosted)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy-backend:
    runs-on: self-hosted

    steps:
      - name: Show runner info
        run: |
          echo "Running on self-hosted EC2 backend runner"
          pwd
          hostname

      - name: Sync repo on EC2
        run: |
          cd /home/ubuntu/moongodb-first-proj
          git fetch origin
          git reset --hard origin/main

      - name: Install dependencies
        run: |
          cd /home/ubuntu/moongodb-first-proj
          npm ci

      - name: Reload with PM2
        run: |
          cd /home/ubuntu/moongodb-first-proj
          pm2 startOrReload ecosystem.config.js 
          pm2 save

      - name: Health check
        run: |
          curl -f http://127.0.0.1/health || (echo "Health check failed" && exit 1)
